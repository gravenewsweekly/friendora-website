<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendora.space - Edit Profile</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Friendora.space</h1>
    </header>
    <main>
        <h2>Edit Your Profile</h2>
        <form id="editProfileForm" onsubmit="handleSave(event)">
            <div class="form-group">
                <label for="profilePic">Profile Picture:</label>
                <input type="file" id="profilePic" accept="image/*">
                <img id="previewPic" src="" alt="Preview" style="display: none; max-width: 100px;">
            </div>
            <div class="form-group">
                <label for="nickname">Nickname:</label>
                <input type="text" id="nickname" name="nickname">
            </div>
            <div class="form-group">
                <label for="age">Age:</label>
                <input type="number" id="age" name="age" min="13" max="120">
            </div>
            <div class="form-group">
                <label for="height">Height (cm):</label>
                <input type="number" id="height" name="height" min="50" max="300">
            </div>
            <div class="form-group">
                <label for="bio">Bio:</label>
                <textarea id="bio" name="bio" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="education">College/School (Mandatory):</label>
                <input type="text" id="education" name="education" required>
            </div>
            <div class="form-group">
                <label for="interests">Interests (comma-separated):</label>
                <input type="text" id="interests" name="interests">
            </div>
            <div class="form-group">
                <label for="flair">Flair (Emoji):</label>
                <input type="text" id="flair" name="flair" maxlength="2" placeholder="e.g., ðŸ˜Š">
            </div>
            <div class="form-group">
                <label for="hobbies">Hobbies (comma-separated):</label>
                <input type="text" id="hobbies" name="hobbies">
            </div>
            <div class="form-group">
                <label for="favThings">Favorite Things to Do (comma-separated):</label>
                <input type="text" id="favThings" name="favThings">
            </div>
            <div class="form-group">
                <label for="relationship">Relationship Status:</label>
                <select id="relationship" name="relationship">
                    <option value="">Select</option>
                    <option value="Single">Single</option>
                    <option value="In a Relationship">In a Relationship</option>
                    <option value="Married">Married</option>
                    <option value="Complicated">Complicated</option>
                </select>
            </div>
            <div class="form-group">
                <label for="contact">Contact Number:</label>
                <input type="tel" id="contact" name="contact" pattern="[0-9]{10}" placeholder="10 digits">
            </div>
            <div class="form-group">
                <label>Online Status:</label>
                <label><input type="radio" name="onlineStatus" value="online" checked> Online</label>
                <label><input type="radio" name="onlineStatus" value="offline"> Offline</label>
            </div>
            <button type="submit">Save</button>
        </form>
        <p id="error" class="error"></p>
    </main>

    <script>
        const API_KEY = '$2a$10$HNoicrOUVIdSCO7LAZz2t.3eGaPo9B2sdd.H/Kld6QJNV/putNShO';
        const BIN_ID = '67e720848a456b79667ea63a';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const loggedInUser = localStorage.getItem('loggedInUser');

        async function fetchUsers() {
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: { 'X-Master-Key': API_KEY }
                });
                if (!response.ok) throw new Error('Failed to fetch users');
                const data = await response.json();
                return data.record.users || [];
            } catch (error) {
                console.error('Error fetching users:', error);
                return [];
            }
        }

        async function saveUsers(users) {
            try {
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify({ users })
                });
                if (!response.ok) throw new Error('Failed to save users');
                return true;
            } catch (error) {
                console.error('Error saving users:', error);
                return false;
            }
        }

        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML.replace(/[<>&"']/g, '');
        }

        async function loadProfile() {
            if (!loggedInUser) {
                document.getElementById('error').textContent = 'Please log in to edit your profile.';
                setTimeout(() => window.location.href = 'login.html', 2000); // Redirect after 2s
                return;
            }

            const users = await fetchUsers();
            const user = users.find(u => u.username === loggedInUser);
            if (!user) {
                document.getElementById('error').textContent = 'User not found. Please sign up.';
                setTimeout(() => window.location.href = 'signup.html', 2000);
                return;
            }

            const profile = user.profile || {};
            document.getElementById('nickname').value = profile.nickname || '';
            document.getElementById('age').value = profile.age || '';
            document.getElementById('height').value = profile.height || '';
            document.getElementById('bio').value = profile.bio || '';
            document.getElementById('education').value = profile.education || '';
            document.getElementById('interests').value = profile.interests || '';
            document.getElementById('flair').value = profile.flair || '';
            document.getElementById('hobbies').value = profile.hobbies || '';
            document.getElementById('favThings').value = profile.favThings || '';
            document.getElementById('relationship').value = profile.relationship || '';
            document.getElementById('contact').value = profile.contact || '';
            document.querySelector(`input[name="onlineStatus"][value="${profile.onlineStatus || 'online'}"]`).checked = true;
            if (profile.profilePic) {
                document.getElementById('previewPic').src = profile.profilePic;
                document.getElementById('previewPic').style.display = 'block';
            }
        }

        document.getElementById('profilePic').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('previewPic');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        async function handleSave(event) {
            event.preventDefault();
            const errorElement = document.getElementById('error');

            if (!loggedInUser) {
                errorElement.textContent = 'Please log in to save your profile.';
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }

            const profilePic = document.getElementById('previewPic').src || '';
            const nickname = sanitizeInput(document.getElementById('nickname').value.trim());
            const age = document.getElementById('age').value;
            const height = document.getElementById('height').value;
            const bio = sanitizeInput(document.getElementById('bio').value.trim());
            const education = sanitizeInput(document.getElementById('education').value.trim());
            const interests = sanitizeInput(document.getElementById('interests').value.trim());
            const flair = sanitizeInput(document.getElementById('flair').value.trim());
            const hobbies = sanitizeInput(document.getElementById('hobbies').value.trim());
            const favThings = sanitizeInput(document.getElementById('favThings').value.trim());
            const relationship = document.getElementById('relationship').value;
            const contact = sanitizeInput(document.getElementById('contact').value.trim());
            const onlineStatus = document.querySelector('input[name="onlineStatus"]:checked').value;

            if (!education) {
                errorElement.textContent = 'College/School is mandatory.';
                return;
            }
            if (contact && !/^[0-9]{10}$/.test(contact)) {
                errorElement.textContent = 'Contact number must be 10 digits.';
                return;
            }

            const users = await fetchUsers();
            const userIndex = users.findIndex(u => u.username === loggedInUser);
            if (userIndex === -1) {
                errorElement.textContent = 'User not found. Please sign up.';
                setTimeout(() => window.location.href = 'signup.html', 2000);
                return;
            }

            users[userIndex].profile = {
                profilePic, nickname, age, height, bio, education, interests, flair,
                hobbies, favThings, relationship, contact, onlineStatus
            };

            const success = await saveUsers(users);
            if (success) {
                window.location.href = `profile.html?username=${encodeURIComponent(loggedInUser)}`;
            } else {
                errorElement.textContent = 'Failed to save profile. Please try again.';
            }
        }

        window.onload = function() {
            loadProfile();
        };
    </script>
</body>
</html>
