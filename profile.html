<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendora.space - Profile</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-container">
            <h1><i class="fas fa-users"></i> Friendora.space</h1>
            <nav>
                <ul id="navLinks">
                    <li id="authLink"><a href="signup.html"><i class="fas fa-user-plus"></i> Signup</a></li>
                    <li><a href="about.html"><i class="fas fa-info-circle"></i> About</a></li>
                    <li><a href="feed.html"><i class="fas fa-newspaper"></i> Feed</a></li>
                    <li><a href="qans.html"><i class="fas fa-question-circle"></i> Q/Ans</a></li>
                </ul>
                <div id="userDropdown" class="dropdown" style="display: none;">
                    <span id="usernameDisplay"><i class="fas fa-user-circle"></i> <span id="usernameText"></span></span>
                    <div class="dropdown-content">
                        <a href="edit-profile.html"><i class="fas fa-user-edit"></i> Edit Profile</a>
                        <a href="profile.html"><i class="fas fa-user"></i> View Profile</a>
                        <a href="login.html" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Log Out</a>
                    </div>
                </div>
            </nav>
            <button id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <main class="profile-main">
        <div class="profile-header">
            <div class="profile-avatar">
                <div id="avatarPlaceholder">
                    <span id="avatarFlair">ðŸ‘¤</span>
                </div>
                <img id="profilePic" src="" alt="Profile Picture" style="display: none;">
                <div class="online-status-indicator" id="onlineStatusIndicator"></div>
            </div>
            <div class="profile-info">
                <h1 id="usernameTitle">Profile</h1>
                <div class="last-seen" id="lastSeen">Last seen: loading...</div>
                <div class="profile-stats">
                    <div class="stat">
                        <span class="stat-number" id="friendsCount">0</span>
                        <span class="stat-label">Friends</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number" id="postsCount">0</span>
                        <span class="stat-label">Posts</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number" id="questionsCount">0</span>
                        <span class="stat-label">Questions</span>
                    </div>
                </div>
                <div class="profile-actions">
                    <button id="messageBtn" class="btn"><i class="fas fa-envelope"></i> Message</button>
                    <button id="friendBtn" class="btn"><i class="fas fa-user-plus"></i> Add Friend</button>
                    <button id="followBtn" class="btn secondary" style="display: none;"><i class="fas fa-user-plus"></i> Follow</button>
                </div>
            </div>
        </div>

        <div class="profile-content">
            <div class="profile-details">
                <h2><i class="fas fa-info-circle"></i> About</h2>
                <div class="detail-item">
                    <i class="fas fa-user-tag"></i>
                    <div>
                        <span class="detail-label">Nickname:</span>
                        <span id="nickname" class="detail-value">Not set</span>
                    </div>
                </div>
                <div class="detail-item">
                    <i class="fas fa-birthday-cake"></i>
                    <div>
                        <span class="detail-label">Age:</span>
                        <span id="age" class="detail-value">Not set</span>
                    </div>
                </div>
                <div class="detail-item">
                    <i class="fas fa-ruler-vertical"></i>
                    <div>
                        <span class="detail-label">Height:</span>
                        <span id="height" class="detail-value">Not set</span>
                    </div>
                </div>
                <div class="detail-item">
                    <i class="fas fa-graduation-cap"></i>
                    <div>
                        <span class="detail-label">College/School:</span>
                        <span id="education" class="detail-value">Not set</span>
                    </div>
                </div>
                <div class="detail-item">
                    <i class="fas fa-heart"></i>
                    <div>
                        <span class="detail-label">Relationship Status:</span>
                        <span id="relationship" class="detail-value">Not set</span>
                    </div>
                </div>
                <div class="detail-item">
                    <i class="fas fa-phone"></i>
                    <div>
                        <span class="detail-label">Contact:</span>
                        <span id="contact" class="detail-value">Not set</span>
                    </div>
                </div>
                <div class="detail-item">
                    <i class="fas fa-circle"></i>
                    <div>
                        <span class="detail-label">Status:</span>
                        <span id="onlineStatus" class="detail-value">Not set</span>
                    </div>
                </div>
            </div>

            <div class="profile-bio">
                <h2><i class="fas fa-book-open"></i> Bio</h2>
                <p id="bio">No bio yet.</p>
            </div>

            <div class="profile-interests">
                <h2><i class="fas fa-star"></i> Interests & Hobbies</h2>
                <div class="tags-container" id="interestsContainer"></div>
                
                <h3><i class="fas fa-gamepad"></i> Hobbies</h3>
                <div class="tags-container" id="hobbiesContainer"></div>
                
                <h3><i class="fas fa-heart"></i> Favorite Things</h3>
                <div class="tags-container" id="favThingsContainer"></div>
            </div>

            <div class="profile-friends">
                <h2><i class="fas fa-user-friends"></i> Friends <span class="refresh-btn" id="refreshFriends"><i class="fas fa-sync-alt"></i></span></h2>
                <div class="friends-list" id="friendsList">
                    <p>Loading friends...</p>
                </div>
            </div>

            <div class="recent-activity">
                <h2><i class="fas fa-history"></i> Recent Activity</h2>
                <div class="activity-feed" id="userActivityFeed">
                    <div class="activity-item">
                        <div class="activity-loader"></div>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>

        <p id="error" class="error"></p>
    </main>

    <footer>
        <div class="footer-content">
            <p>Â© 2025 Friendora.space. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const API_KEY = '$2a$10$HNoicrOUVIdSCO7LAZz2t.3eGaPo9B2sdd.H/Kld6QJNV/putNShO';
        const BIN_ID = '67e720848a456b79667ea63a';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const loggedInUser = localStorage.getItem('loggedInUser');
        let profileUpdateInterval;

        // Update navigation based on login status
        function updateNavigation() {
            const authLink = document.getElementById('authLink');
            const userDropdown = document.getElementById('userDropdown');
            const usernameText = document.getElementById('usernameText');

            if (loggedInUser) {
                authLink.style.display = 'none';
                userDropdown.style.display = 'inline-block';
                usernameText.textContent = loggedInUser;
            } else {
                authLink.style.display = 'inline-block';
                userDropdown.style.display = 'none';
            }
        }

        // Fetch users from JSONBin
        async function fetchUsers() {
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: { 'X-Master-Key': API_KEY }
                });
                if (!response.ok) throw new Error('Failed to fetch users');
                const data = await response.json();
                return data.record.users || [];
            } catch (error) {
                console.error('Error fetching users:', error);
                return [];
            }
        }

        // Create tag elements from comma-separated string
        function createTags(containerId, items) {
            const container = document.getElementById(containerId);
            if (!items || items.trim() === '') {
                container.innerHTML = '<span class="empty-tag">Not specified</span>';
                return;
            }
            
            container.innerHTML = items.split(',').map(item => 
                `<span class="tag">${item.trim()}</span>`
            ).join('');
        }

        // Generate random activity for user
        function generateUserActivity() {
            const activities = [
                'Posted a new update',
                'Added new photos',
                'Commented on a post',
                'Liked a question',
                'Joined a discussion',
                'Updated their profile',
                'Answered a question',
                'Started following someone'
            ];
            
            const numActivities = 3 + Math.floor(Math.random() * 3); // 3-5 activities
            const result = [];
            
            for (let i = 0; i < numActivities; i++) {
                const hoursAgo = i * 2;
                result.push({
                    action: activities[Math.floor(Math.random() * activities.length)],
                    time: hoursAgo === 0 ? 'Just now' : `${hoursAgo} hours ago`
                });
            }
            
            return result;
        }

        // Update user activity feed
        function updateUserActivityFeed(username) {
            const activities = generateUserActivity();
            const feed = document.getElementById('userActivityFeed');
            
            feed.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="activity-content">
                        <strong>${username}</strong> ${activity.action}
                        <span class="activity-time">${activity.time}</span>
                    </div>
                </div>
            `).join('');
        }

        // Display friends list
        async function displayFriends(username) {
            const users = await fetchUsers();
            const currentUser = users.find(u => u.username === username);
            const friendsList = document.getElementById('friendsList');
            
            if (!currentUser || !currentUser.friends || currentUser.friends.length === 0) {
                friendsList.innerHTML = '<p>No friends to display.</p>';
                return;
            }
            
            // Get friend profiles
            const friends = currentUser.friends
                .map(friendName => users.find(u => u.username === friendName))
                .filter(Boolean)
                .slice(0, 6); // Show first 6 friends
            
            if (friends.length > 0) {
                friendsList.innerHTML = friends.map(friend => `
                    <div class="friend-card" onclick="window.location.href='profile.html?username=${encodeURIComponent(friend.username)}'">
                        <div class="friend-avatar">
                            ${friend.profile?.flair || 'ðŸ‘¤'}
                            ${friend.profile?.profilePic ? 
                                `<img src="${friend.profile.profilePic}" alt="${friend.username}" class="friend-avatar-img">` : ''}
                            <div class="friend-status ${friend.profile?.onlineStatus === 'online' ? 'online' : 'offline'}"></div>
                        </div>
                        <div class="friend-info">
                            <span class="friend-name">${friend.username}</span>
                            <span class="friend-status-text">${friend.profile?.onlineStatus === 'online' ? 'Online' : 'Offline'}</span>
                        </div>
                    </div>
                `).join('');
                
                // Add "View All" button if more than 6 friends
                if (currentUser.friends.length > 6) {
                    friendsList.innerHTML += `
                        <div class="view-all-friends">
                            <button class="btn secondary" onclick="window.location.href='friends.html?username=${encodeURIComponent(username)}'">
                                View All ${currentUser.friends.length} Friends
                            </button>
                        </div>
                    `;
                }
            } else {
                friendsList.innerHTML = '<p>No friends to display.</p>';
            }
        }

        // Load profile data
        async function loadProfile() {
            updateNavigation();
            
            const params = new URLSearchParams(window.location.search);
            const urlUsername = params.get('username');
            const username = urlUsername || loggedInUser;
            const errorElement = document.getElementById('error');

            if (!username) {
                errorElement.textContent = 'No user specified. Please log in or search for a user.';
                return;
            }

            const users = await fetchUsers();
            const user = users.find(u => u.username === username);

            if (!user) {
                errorElement.textContent = 'User not found.';
                document.getElementById('usernameTitle').textContent = 'Profile Not Found';
                return;
            }

            // Display profile data
            document.getElementById('usernameTitle').textContent = `${username}'s Profile`;
            const profile = user.profile || {};

            // Avatar/Profile Picture
            if (profile.profilePic) {
                document.getElementById('profilePic').src = profile.profilePic;
                document.getElementById('profilePic').style.display = 'block';
                document.getElementById('avatarPlaceholder').style.display = 'none';
            } else if (profile.flair) {
                document.getElementById('avatarFlair').textContent = profile.flair;
            }

            // Online status indicator
            const onlineStatusIndicator = document.getElementById('onlineStatusIndicator');
            if (profile.onlineStatus === 'online') {
                onlineStatusIndicator.classList.add('online');
                onlineStatusIndicator.title = 'Online now';
            } else {
                onlineStatusIndicator.classList.add('offline');
                onlineStatusIndicator.title = 'Offline';
            }

            // Basic info
            document.getElementById('nickname').textContent = profile.nickname || 'Not set';
            document.getElementById('age').textContent = profile.age || 'Not set';
            document.getElementById('height').textContent = profile.height ? `${profile.height} cm` : 'Not set';
            document.getElementById('bio').textContent = profile.bio || 'No bio yet.';
            document.getElementById('education').textContent = profile.education || 'Not set';
            document.getElementById('relationship').textContent = profile.relationship || 'Not set';
            document.getElementById('contact').textContent = profile.contact || 'Not set';
            
            // Online status with color coding
            const onlineStatusElement = document.getElementById('onlineStatus');
            if (profile.onlineStatus === 'online') {
                onlineStatusElement.textContent = 'Online';
                onlineStatusElement.classList.add('online');
                document.getElementById('lastSeen').textContent = 'Active now';
            } else {
                onlineStatusElement.textContent = 'Offline';
                onlineStatusElement.classList.add('offline');
                document.getElementById('lastSeen').textContent = 'Last seen: a while ago';
            }

            // Tags
            createTags('interestsContainer', profile.interests);
            createTags('hobbiesContainer', profile.hobbies);
            createTags('favThingsContainer', profile.favThings);

            // Stats (simulated)
            document.getElementById('friendsCount').textContent = user.friends?.length || 0;
            document.getElementById('postsCount').textContent = user.posts?.length || 0;
            document.getElementById('questionsCount').textContent = user.questions?.length || 0;

            // Friend button logic
            const friendBtn = document.getElementById('friendBtn');
            const followBtn = document.getElementById('followBtn');
            if (loggedInUser === username) {
                friendBtn.style.display = 'none';
                followBtn.style.display = 'none';
                document.getElementById('messageBtn').style.display = 'none';
            } else {
                friendBtn.addEventListener('click', () => {
                    friendBtn.innerHTML = '<i class="fas fa-check"></i> Friend Request Sent';
                    friendBtn.disabled = true;
                });
                
                // Show follow button if not friends
                if (!user.friends?.includes(loggedInUser)) {
                    followBtn.style.display = 'inline-block';
                    friendBtn.style.display = 'none';
                }
            }

            // Load friends and activity
            displayFriends(username);
            updateUserActivityFeed(username);
            
            // Start profile updates
            profileUpdateInterval = setInterval(() => {
                updateOnlineStatus(username);
            }, 30000); // Check every 30 seconds
        }

        // Update online status in real-time
        async function updateOnlineStatus(username) {
            const users = await fetchUsers();
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            const profile = user.profile || {};
            const onlineStatusElement = document.getElementById('onlineStatus');
            const onlineStatusIndicator = document.getElementById('onlineStatusIndicator');
            const lastSeenElement = document.getElementById('lastSeen');
            
            if (profile.onlineStatus === 'online') {
                onlineStatusElement.textContent = 'Online';
                onlineStatusElement.className = 'detail-value online';
                onlineStatusIndicator.className = 'online-status-indicator online';
                onlineStatusIndicator.title = 'Online now';
                lastSeenElement.textContent = 'Active now';
            } else {
                onlineStatusElement.textContent = 'Offline';
                onlineStatusElement.className = 'detail-value offline';
                onlineStatusIndicator.className = 'online-status-indicator offline';
                onlineStatusIndicator.title = 'Offline';
                lastSeenElement.textContent = 'Last seen: a while ago';
            }
        }

        // Refresh friends list
        document.getElementById('refreshFriends')?.addEventListener('click', function() {
            const params = new URLSearchParams(window.location.search);
            const username = params.get('username') || loggedInUser;
            
            this.classList.add('refreshing');
            displayFriends(username).then(() => {
                setTimeout(() => this.classList.remove('refreshing'), 500);
            });
        });

        // Mobile menu toggle
        document.getElementById('mobileMenuBtn')?.addEventListener('click', function() {
            const navLinks = document.getElementById('navLinks');
            navLinks.style.display = navLinks.style.display === 'flex' ? 'none' : 'flex';
        });

        window.onload = function() {
            loadProfile();
        };
        
        // Clean up interval when page unloads
        window.addEventListener('beforeunload', function() {
            clearInterval(profileUpdateInterval);
        });
    </script>
</body>
</html>
